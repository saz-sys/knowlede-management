# 実装計画: 動画サムネイル抽出機能

**ブランチ**: `001-feature-name-description` | **日付**: 2025年9月5日 | **仕様**: [spec.md](spec.md)
**入力**: `/specs/001-feature-name-description/spec.md` からの機能仕様

## 実行フロー (/plan コマンドスコープ)
```
1. 入力パスから機能仕様を読み込み
   → 見つからない場合: ERROR "仕様が見つかりません: {path}"
2. 技術的コンテキストを記入（要明確化をスキャン）
   → コンテキストからプロジェクトタイプを検出（web=frontend+backend、mobile=app+api）
   → プロジェクトタイプに基づいて構造決定を設定
3. 以下の規約チェックセクションを評価
   → 違反が存在する場合: 複雑性追跡に文書化
   → 正当化が不可能な場合: ERROR "まずアプローチを簡素化"
   → 進捗追跡を更新: 初期規約チェック
4. フェーズ0を実行 → research.md
   → 要明確化が残っている場合: ERROR "不明点を解決"
5. フェーズ1を実行 → contracts、data-model.md、quickstart.md、エージェント固有テンプレートファイル（例：Claude Code用`CLAUDE.md`、GitHub Copilot用`.github/copilot-instructions.md`、Gemini CLI用`GEMINI.md`）
6. 規約チェックセクションを再評価
   → 新しい違反がある場合: 設計をリファクタ、フェーズ1に戻る
   → 進捗追跡を更新: 設計後規約チェック
7. フェーズ2を計画 → タスク生成アプローチを説明（tasks.mdは作成しない）
8. 停止 - /tasksコマンドの準備完了
```

**重要**: /planコマンドはステップ7で停止します。フェーズ2-4は他のコマンドで実行されます：
- フェーズ2: /tasksコマンドがtasks.mdを作成
- フェーズ3-4: 実装実行（手動またはツール経由）

## 概要
社内非エンジニア向けのデスクトップアプリケーションで、MP4動画からキャラクターの顔が写った複数のサムネイルをPNG形式で抽出する。AIを活用してできるだけ異なる構図のサムネイルを選択し、ユーザーがサイズと枚数を指定可能。完全にローカル環境で動作し、機密性を保つ。

## 技術的コンテキスト
**言語/バージョン**: Python 3.11+
**主要依存関係**: 
- GUI: tkinter（標準ライブラリ、ローカル完結）
- 動画処理: OpenCV (cv2)
- AI/ML: MediaPipe（Googleの顔検出、ローカル動作）
- 画像処理: PIL/Pillow
- 数値計算: NumPy
**ストレージ**: ローカルファイルシステムのみ（データベース不要）
**テスト**: pytest
**対象プラットフォーム**: Windows/macOS/Linux デスクトップ
**プロジェクトタイプ**: single（デスクトップアプリケーション）
**パフォーマンス目標**: 10分動画から5枚のサムネイル抽出を30秒以内
**制約**: 
- ローカル完結（外部ネットワークアクセス禁止）
- MP4形式のみ対応
- PNG出力のみ
- 顔検出必須（顔がない場合は適切なエラー）
**規模/スコープ**: 単一デスクトップアプリ、GUI + ライブラリ構成

## 規約チェック
*ゲート: フェーズ0研究前に合格必須。フェーズ1設計後に再チェック。*

**簡潔性**:
- プロジェクト数: 2 (デスクトップアプリ + 抽出ライブラリ) ✓ 最大3以下
- フレームワークを直接使用？ ✓ tkinter、OpenCV、MediaPipeを直接使用
- 単一データモデル？ ✓ 動画フレーム、サムネイル設定のシンプルなデータ構造
- パターンを避ける？ ✓ シンプルなクラス構造、不要なデザインパターンなし

**アーキテクチャ**:
- すべての機能をライブラリとして？ ✓ 抽出機能をライブラリ化、GUIは薄いインターフェース
- ライブラリリスト: 
  - thumbnail_extractor: 動画解析、顔検出、サムネイル抽出
  - gui_app: tkinterベースのユーザーインターフェース
- ライブラリごとのCLI: 
  - thumbnail_extractor: --help, --version, --extract コマンド
  - gui_app: --help, --version, --launch コマンド
- ライブラリドキュメント: ✓ llms.txt形式を計画

**テスト（非交渉）**:
- RED-GREEN-Refactorサイクルを強制？ ✓ テストファーストアプローチ
- Gitコミットで実装前にテストを表示？ ✓ 失敗するテストをコミット
- 順序: Contract→Integration→E2E→Unitを厳密に遵守？ ✓ 
- 実際の依存関係を使用？ ✓ 実際のサンプル動画でテスト
- 統合テスト対象: 動画読み込み、顔検出、サムネイル生成パイプライン
- 禁止: テスト前の実装、REDフェーズのスキップ

**可観測性**:
- 構造化ログを含む？ ✓ JSON形式でのログ出力
- フロントエンドログ → バックエンド？ N/A（デスクトップアプリ）
- エラーコンテキストは十分？ ✓ 詳細なエラー情報とユーザー向けメッセージ

**バージョニング**:
- バージョン番号が割り当てられている？ ✓ MAJOR.MINOR.BUILD形式
- すべての変更でBUILDが増加？ ✓ 
- 破壊的変更を処理？ ✓ APIバージョニング計画

## プロジェクト構造

### ドキュメント（この機能）
```
specs/001-feature-name-description/
├── plan.md              # このファイル（/planコマンド出力）
├── research.md          # フェーズ0出力（/planコマンド）
├── data-model.md        # フェーズ1出力（/planコマンド）
├── quickstart.md        # フェーズ1出力（/planコマンド）
├── contracts/           # フェーズ1出力（/planコマンド）
└── tasks.md             # フェーズ2出力（/tasksコマンド - /planでは作成されない）
```

### ソースコード（リポジトリルート）
```
# 単一プロジェクト構成（デスクトップアプリケーション）
src/
├── models/              # データモデル
│   ├── video_file.py    # 動画ファイル情報
│   ├── frame.py         # フレーム情報
│   ├── thumbnail.py     # サムネイル情報
│   └── user_settings.py # ユーザー設定
├── services/            # コアサービス
│   ├── video_processor.py     # 動画読み込み・解析
│   ├── face_detector.py       # MediaPipe顔検出
│   ├── thumbnail_extractor.py # サムネイル抽出
│   └── diversity_selector.py  # AI構図多様性選択
├── cli/                 # コマンドラインインターフェース
│   └── main.py          # CLI エントリーポイント
├── gui/                 # GUI アプリケーション
│   ├── main_window.py   # メインウィンドウ
│   ├── settings_dialog.py # 設定ダイアログ
│   └── thumbnail_grid.py  # サムネイル表示グリッド
└── lib/                 # ユーティリティ
    ├── logger.py        # ログ管理
    ├── config.py        # 設定管理
    └── errors.py        # カスタム例外

tests/
├── contract/            # API契約テスト
├── integration/         # 統合テスト
│   ├── test_video_processing_pipeline.py
│   ├── test_face_detection_integration.py
│   └── test_thumbnail_extraction_e2e.py
└── unit/               # ユニットテスト
    ├── test_video_processor.py
    ├── test_face_detector.py
    └── test_thumbnail_extractor.py

requirements.txt        # 依存関係
setup.py               # パッケージ設定
llms.txt              # AI開発者向けドキュメント
```

**構造決定**: デスクトップアプリケーションのため単一プロジェクト構成を使用

## フェーズ0: 概要と研究
1. **上記の技術的コンテキストから不明点を抽出**:
   - MediaPipeの顔検出精度とパフォーマンス
   - OpenCVでの効率的な動画フレーム抽出方法
   - 構図多様性を判定するAIアルゴリズム選択
   - tkinterでのレスポンシブなGUI設計
   - ローカル環境でのAI処理最適化

2. **研究エージェントを生成して派遣**:
   ```
   タスク: "アニメ動画でのMediaPipe顔検出の精度と最適化を研究"
   タスク: "OpenCVでのMP4動画フレーム抽出のベストプラクティスを見つける"
   タスク: "画像構図多様性判定のローカルAIアルゴリズムを研究"
   タスク: "tkinterでの大量画像表示とレスポンシブ設計を研究"
   タスク: "Python機械学習ライブラリのローカル実行最適化を研究"
   ```

3. **結果を統合** `research.md` に以下の形式で:
   - 決定: [選択されたもの]
   - 根拠: [選択理由]
   - 検討された代替案: [他に評価されたもの]

**出力**: すべての要明確化が解決されたresearch.md

## フェーズ1: 設計と契約
*前提条件: research.md完了*

1. **機能仕様からエンティティを抽出** → `data-model.md`:
   - VideoFile, Frame, Thumbnail, UserSettings, FaceDetectionResult
   - バリデーションルール、状態遷移
   - フレーム選択アルゴリズムの仕様

2. **機能要件からAPI契約を生成**:
   - ライブラリAPIとしてのインターフェース設計
   - 各サービスクラスの公開メソッド仕様
   - エラーハンドリング契約
   - CLI・GUIインターフェース仕様

3. **契約から契約テストを生成**:
   - 各APIメソッドのテストケース
   - 入力検証、出力検証
   - エラーケースのテスト

4. **ユーザーストーリーからテストシナリオを抽出**:
   - 動画選択→設定→生成→保存の統合テスト
   - 各エッジケースのテストシナリオ

**出力**: data-model.md、/contracts/*、失敗するテスト、quickstart.md

## フェーズ2: タスク計画アプローチ
*このセクションは/tasksコマンドが行うことを説明 - /plan中は実行しない*

**タスク生成戦略**:
- `/templates/tasks-template.md`をベースとして読み込み
- フェーズ1設計ドキュメント（契約、データモデル、クイックスタート）からタスクを生成
- 各データモデル → モデル作成タスク [P]
- 各サービス契約 → サービス実装タスク
- 各GUI コンポーネント → GUI実装タスク
- 統合テスト → エンドツーエンドテスト実装

**順序戦略**:
- TDD順序: 実装前にテスト
- 依存関係順序: モデル→サービス→CLI→GUI
- 並列実行用に[P]をマーク（独立ファイル）

**推定出力**: tasks.mdに25-30の番号付き、順序付きタスク

**重要**: このフェーズは/tasksコマンドで実行され、/planではない

## フェーズ3+: 将来の実装
*これらのフェーズは/planコマンドの範囲外*

**フェーズ3**: タスク実行（/tasksコマンドがtasks.mdを作成）
**フェーズ4**: 実装（規約原則に従ってtasks.mdを実行）
**フェーズ5**: 検証（テスト実行、quickstart.md実行、パフォーマンス検証）

## 複雑性追跡
*規約チェックで正当化が必要な違反がある場合のみ記入*

| 違反 | 必要な理由 | より簡単な代替案が拒否された理由 |
|------|------------|----------------------------------|
| なし | - | - |

## 進捗追跡
*このチェックリストは実行フロー中に更新される*

**フェーズステータス**:
- [x] フェーズ0: 研究完了（/planコマンド）
- [x] フェーズ1: 設計完了（/planコマンド）
- [x] フェーズ2: タスク計画完了（/planコマンド - アプローチ説明のみ）
- [x] フェーズ3: タスク生成（/tasksコマンド）
- [ ] フェーズ4: 実装完了
- [ ] フェーズ5: 検証合格

**ゲートステータス**:
- [x] 初期規約チェック: 合格
- [x] 設計後規約チェック: 合格
- [x] すべての要明確化解決
- [x] 複雑性逸脱文書化（逸脱なし）